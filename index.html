<!DOCTYPE html>
<html lang="en">

<head>
  <base href="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/">
  <link rel="icon" type="image/png" href="https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa">
  <link rel="icon" type="image/png" sizes="32x32" href="https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa">
  <link rel="apple-touch-icon" href="https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Network GN Math</title>
  <style>
    /* ---------- RECENT REMOVE BUTTON ---------- */
    .recent-remove {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 34px;
      height: 34px;
      background: rgba(0, 0, 0, 0.55);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.6);
      transition: all 0.25s ease;
      cursor: pointer;
      z-index: 6;
    }

    .zone-item:hover .recent-remove {
      opacity: 1;
      transform: scale(1);
    }

    .recent-remove svg {
      width: 18px;
      height: 18px;
      stroke: #ff5c5c;
      stroke-width: 2;
      fill: none;
    }

    .recent-remove:hover {
      background: rgba(255, 0, 0, 0.6);
    }

    /* ---------- FAVORITES STAR ---------- */
    .zone-item {
      position: relative;
    }

    /* star button */
    .favorite-star {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 34px;
      height: 34px;
      background: rgba(0, 0, 0, 0.55);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.6);
      transition: all 0.25s ease;
      cursor: pointer;
      z-index: 5;
    }

    /* show on hover */
    .zone-item:hover .favorite-star {
      opacity: 1;
      transform: scale(1);
    }

    .favorite-star svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: gold;
      stroke-width: 2;
    }

    /* filled when active */
    .favorite-star.active svg {
      fill: gold;
    }

    /* particle */
    .star-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: gold;
      border-radius: 50%;
      pointer-events: none;
      animation: particle 600ms ease-out forwards;
    }

    @keyframes particle {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translate(var(--x), var(--y)) scale(0);
        opacity: 0;
      }
    }

    .summary-content {
      display: flex;
      justify-content: space-between;
      /* text left, button right */
      align-items: center;
      width: 100%;
    }

    .clear-recent {
      background: rgba(255, 80, 80, 0.2);
      border: 1px solid rgba(255, 80, 80, 0.4);
      padding: 0.4rem 0.9rem;
      border-radius: 9999px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 0.9rem;
    }

    .clear-recent:hover {
      background: rgba(255, 80, 80, 0.4);
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 80, 80, 0.3);
    }

    details summary {
      padding: 0.9rem 1.2rem;
      background: var(--summary-bg, rgba(0, 0, 255, 0.2));
      border-radius: 10px;
      box-shadow: 0 2px 6px var(--primary-glow);
      transition: all 0.2s ease;
      color: var(--text-color);
    }

    details summary:hover {
      background: var(--summary-bg-hover, rgba(0, 0, 255, 0.25));
      transform: translateY(-1px);
      box-shadow: 0 3px 8px var(--primary-glow);
    }

    .control-buttons .control-button {
      margin-right: 0.8rem;
      /* space between Library and Settings */
    }

    .control-button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 20px var(--primary-glow), 0 4px 15px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .control-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .control-button:hover::before {
      width: 300px;
      height: 300px;
    }

    .control-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 30px var(--primary-glow), 0 8px 25px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .control-button:active {
      transform: translateY(-1px);
    }

    .library-button {
      background: #0000ff;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 9999px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .library-button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

/* ---------- CATEGORY NAV BAR ---------- */
.category-nav-wrapper {
  position: sticky;
  top: 0;
  z-index: 99;
  background: linear-gradient(135deg, var(--header-bg-1), var(--header-bg-2));
  border-bottom: 2px solid var(--primary-color);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
  transition: all 0.3s ease;
}

.category-nav-wrapper.collapsed .category-nav {
  max-height: 0;
  opacity: 0;
  padding: 0;
}

.category-toggle {
  width: 100%;
  background: var(--header-bg-1);
  border: none;
  color: white;
  padding: 0.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 700;
  transition: all 0.3s ease;
}

.category-toggle:hover {
  background: var(--header-bg-2);
}

.category-toggle svg {
  width: 16px;
  height: 16px;
  transition: transform 0.3s ease;
}

.category-nav-wrapper.collapsed .category-toggle svg {
  transform: rotate(180deg);
}

.category-nav {
  display: flex;
  gap: 0.5rem;
  padding: 1rem;
  max-width: 1200px;
  margin: 0 auto;
  flex-wrap: wrap;
  justify-content: center;
  max-height: 200px;
  opacity: 1;
  overflow: hidden;
  transition: all 0.3s ease;
}

.category-btn {
  background: var(--input-bg);
  border: 2px solid var(--input-border);
  color: white;
  padding: 0.6rem 1.2rem;
  border-radius: 9999px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(4px);
}

.category-btn:hover {
  background: var(--input-border);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--primary-glow);
}

.category-btn.active {
  background: var(--primary-color);
  border-color: var(--primary-color);
  box-shadow: 0 0 20px var(--primary-glow);
}

/* Hide category sections by default */
.category-section {
  display: none;
}

.category-section.active {
  display: block;
}

    :root {
      --primary-color: #0000ff;
      --primary-glow: rgba(0, 0, 255, 0.4);
      --text-color: #e0e0e0;
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --font-family: 'Montserrat', system-ui, -apple-system, sans-serif;
      --input-bg: rgba(0, 0, 255, 0.08);
      --input-border: rgba(0, 0, 255, 0.3);
      --input-border-focus: #0000ff;
      --header-bg-1: rgba(0, 0, 51, 0.9);
      --header-bg-2: rgba(0, 0, 85, 0.9);
      --summary-bg: rgba(0, 0, 255, 0.2);
      --summary-bg-hover: rgba(0, 0, 255, 0.25);
      --favorites-bg: rgba(0, 0, 255, 0.15);
      --import-color: #0000ff;
      --search-placeholder: rgba(255, 255, 255, 0.5);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Cyberpunk Theme */
    body[data-theme="cyberpunk"] {
      --primary-color: #ff00ff;
      --primary-glow: rgba(255, 0, 255, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 24px rgba(255, 0, 255, 0.2);
      --input-bg: rgba(255, 0, 255, 0.08);
      --input-border: rgba(255, 0, 255, 0.3);
      --input-border-focus: #ff00ff;
      --header-bg-1: rgba(51, 0, 51, 0.9);
      --header-bg-2: rgba(85, 0, 85, 0.9);
      --summary-bg: rgba(255, 0, 255, 0.2);
      --summary-bg-hover: rgba(255, 0, 255, 0.25);
      --favorites-bg: rgba(255, 0, 255, 0.15);
      --import-color: #ff00ff;
      --search-placeholder: rgba(255, 255, 255, 0.5);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Matrix Theme */
    body[data-theme="matrix"] {
      --primary-color: #00cc00;
      --primary-glow: rgba(0, 204, 0, 0.4);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 24px rgba(0, 204, 0, 0.2);
      --input-bg: rgba(0, 204, 0, 0.08);
      --input-border: rgba(0, 204, 0, 0.3);
      --input-border-focus: #00cc00;
      --header-bg-1: rgba(0, 40, 0, 0.9);
      --header-bg-2: rgba(0, 70, 0, 0.9);
      --summary-bg: rgba(0, 204, 0, 0.2);
      --summary-bg-hover: rgba(0, 204, 0, 0.25);
      --favorites-bg: rgba(0, 204, 0, 0.15);
      --import-color: #00cc00;
      --search-placeholder: rgba(255, 255, 255, 0.5);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Sunset Theme */
    body[data-theme="sunset"] {
      --primary-color: #ff6b35;
      --primary-glow: rgba(255, 107, 53, 0.4);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 24px rgba(255, 107, 53, 0.2);
      --input-bg: rgba(255, 107, 53, 0.08);
      --input-border: rgba(255, 107, 53, 0.3);
      --input-border-focus: #ff6b35;
      --header-bg-1: rgba(51, 20, 30, 0.9);
      --header-bg-2: rgba(85, 30, 50, 0.9);
      --summary-bg: rgba(255, 107, 53, 0.2);
      --summary-bg-hover: rgba(255, 107, 53, 0.25);
      --favorites-bg: rgba(255, 107, 53, 0.15);
      --import-color: #ff6b35;
      --search-placeholder: rgba(255, 255, 255, 0.5);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: The Library (Red) */
    body[data-custom-theme="library"] {
      --primary-color: #cc0000;
      --primary-glow: rgba(204, 0, 0, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(204, 0, 0, 0.25);
      --input-bg: rgba(204, 0, 0, 0.08);
      --input-border: rgba(204, 0, 0, 0.35);
      --input-border-focus: #cc0000;
      --header-bg-1: rgba(150, 0, 0, 0.15);
      --header-bg-2: rgba(200, 0, 0, 0.25);
      --summary-bg: rgba(204, 0, 0, 0.15);
      --summary-bg-hover: rgba(204, 0, 0, 0.25);
      --favorites-bg: rgba(204, 0, 0, 0.1);
      --import-color: #cc0000;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: Awesome Elias (Orange) */
    body[data-custom-theme="elias"] {
      --primary-color: #ff8c00;
      --primary-glow: rgba(255, 140, 0, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(255, 140, 0, 0.25);
      --input-bg: rgba(255, 140, 0, 0.08);
      --input-border: rgba(255, 140, 0, 0.35);
      --input-border-focus: #ff8c00;
      --header-bg-1: rgba(255, 140, 0, 0.15);
      --header-bg-2: rgba(255, 100, 0, 0.25);
      --summary-bg: rgba(255, 140, 0, 0.15);
      --summary-bg-hover: rgba(255, 140, 0, 0.25);
      --favorites-bg: rgba(255, 140, 0, 0.1);
      --import-color: #ff8c00;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: Lebron da Goat (Purple) */
    body[data-custom-theme="lebron"] {
      --primary-color: #552583;
      --primary-glow: rgba(85, 37, 131, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(85, 37, 131, 0.25);
      --input-bg: rgba(85, 37, 131, 0.08);
      --input-border: rgba(85, 37, 131, 0.35);
      --input-border-focus: #552583;
      --header-bg-1: rgba(85, 37, 131, 0.15);
      --header-bg-2: rgba(120, 50, 180, 0.25);
      --summary-bg: rgba(85, 37, 131, 0.15);
      --summary-bg-hover: rgba(85, 37, 131, 0.25);
      --favorites-bg: rgba(85, 37, 131, 0.1);
      --import-color: #552583;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: GN Kirk (Red) */
    body[data-custom-theme="kirk"] {
      --primary-color: #e60000;
      --primary-glow: rgba(230, 0, 0, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(230, 0, 0, 0.25);
      --input-bg: rgba(230, 0, 0, 0.08);
      --input-border: rgba(230, 0, 0, 0.35);
      --input-border-focus: #e60000;
      --header-bg-1: rgba(200, 0, 0, 0.15);
      --header-bg-2: rgba(255, 50, 50, 0.25);
      --summary-bg: rgba(230, 0, 0, 0.15);
      --summary-bg-hover: rgba(230, 0, 0, 0.25);
      --favorites-bg: rgba(230, 0, 0, 0.1);
      --import-color: #e60000;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: Steam (Blue-Gray) */
    body[data-custom-theme="steam"] {
      --primary-color: #66c0f4;
      --primary-glow: rgba(102, 192, 244, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(102, 192, 244, 0.25);
      --input-bg: rgba(102, 192, 244, 0.08);
      --input-border: rgba(102, 192, 244, 0.35);
      --input-border-focus: #66c0f4;
      --header-bg-1: rgba(102, 192, 244, 0.15);
      --header-bg-2: rgba(80, 150, 200, 0.25);
      --summary-bg: rgba(102, 192, 244, 0.15);
      --summary-bg-hover: rgba(102, 192, 244, 0.25);
      --favorites-bg: rgba(102, 192, 244, 0.1);
      --import-color: #66c0f4;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: Epstein (Grey, Black, and White) */
    body[data-custom-theme="epstein"] {
      --primary-color: #666666;
      /* Grey */
      --primary-glow: rgba(102, 102, 102, 0.5);
      --background-color: #000000;
      /* Black */
      --card-bg: rgba(30, 30, 30, 0.8);
      --popup-bg: rgba(10, 10, 10, 0.95);
      --shadow: 0 8px 32px rgba(255, 255, 255, 0.1);
      --input-bg: rgba(255, 255, 255, 0.05);
      --input-border: rgba(255, 255, 255, 0.2);
      --input-border-focus: #ffffff;
      /* White */
      --header-bg-1: rgba(20, 20, 20, 0.95);
      --header-bg-2: rgba(0, 0, 0, 0.95);
      --summary-bg: rgba(102, 102, 102, 0.2);
      --summary-bg-hover: rgba(102, 102, 102, 0.3);
      --favorites-bg: rgba(102, 102, 102, 0.1);
      --import-color: #ffffff;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #000000;
      --bg-gradient-2: #1a1a1a;
    }

    /* Custom Theme: Securly (White/Blue) */
    body[data-custom-theme="securly"] {
      --primary-color: #007bff;
      --primary-glow: rgba(0, 123, 255, 0.5);
      --background-color: #f0f2f5;
      --bg-gradient-1: #ffffff;
      --bg-gradient-2: #e9ecef;
      --text-color: #1c1e21;
      --card-bg: rgba(255, 255, 255, 0.9);
      --popup-bg: rgba(255, 255, 255, 0.98);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --header-bg-1: #007bff;
      --header-bg-2: #0056b3;
      --input-bg: #ffffff;
      --input-border: #ced4da;
      --input-border-focus: #007bff;
      --search-placeholder: #6c757d;
      --summary-bg: rgba(0, 123, 255, 0.1);
      --summary-bg-hover: rgba(0, 123, 255, 0.2);
    }

    /* Custom Theme: IXL Style (Green/Cyan/Yellow) */
    body[data-custom-theme="ixl"] {
      --primary-color: #4eb230;
      /* IXL Green */
      --primary-glow: rgba(78, 178, 48, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(78, 178, 48, 0.25);
      --input-bg: rgba(78, 178, 48, 0.08);
      --input-border: rgba(0, 122, 204, 0.35);
      /* Cyan border */
      --input-border-focus: #007acc;
      /* Cyan focus */
      --header-bg-1: rgba(45, 105, 30, 0.9);
      --header-bg-2: rgba(78, 178, 48, 0.9);
      --summary-bg: rgba(0, 122, 204, 0.15);
      /* Cyan summaries */
      --summary-bg-hover: rgba(0, 122, 204, 0.25);
      --favorites-bg: rgba(255, 199, 44, 0.15);
      /* Yellow favorites */
      --import-color: #4eb230;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    /* Custom Theme: Camzzz (Modern Purple) */
    body[data-custom-theme="camzzz"] {
      --primary-color: #AA00FF;
      --primary-glow: rgba(170, 0, 255, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(170, 0, 255, 0.25);
      --input-bg: rgba(170, 0, 255, 0.08);
      --input-border: rgba(170, 0, 255, 0.35);
      --input-border-focus: #AA00FF;
      --header-bg-1: rgba(40, 0, 60, 0.9);
      --header-bg-2: rgba(70, 0, 110, 0.9);
      --summary-bg: rgba(170, 0, 255, 0.15);
      --summary-bg-hover: rgba(170, 0, 255, 0.25);
      --favorites-bg: rgba(170, 0, 255, 0.1);
      --import-color: #AA00FF;
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }

    *,
    *::before,
    *::after {
      font-family: var(--font-family) !important;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-weight: 500;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
      background-attachment: fixed;
      color: var(--text-color);
      overflow-x: hidden;
      transition: background 0.5s ease, color 0.5s ease;
      min-height: 100vh;
    }

    /* Animated Background Particles */
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 50%;
      opacity: 0.4;
      animation: float linear infinite;
      box-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
    }

    @keyframes float {
      0% {
        transform: translateY(0) translateX(0);
        opacity: 0;
      }

      10% {
        opacity: 0.4;
      }

      90% {
        opacity: 0.4;
      }

      100% {
        transform: translateY(-100vh) translateX(50px);
        opacity: 0;
      }
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    summary,
    button,
    .zone-item button,
    #popupTitle,
    #zoneName,
    .logo,
    .control-buttons button,
    .zone-controls button {
      font-weight: 800 !important;
    }

    input {
      font-weight: 600;
    }

    header {
      background: linear-gradient(135deg, var(--header-bg-1), var(--header-bg-2));
      backdrop-filter: blur(20px);
      padding: 1.2rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow), 0 0 30px var(--primary-glow);
      border-bottom: 2px solid var(--primary-color);
      transition: all 0.5s ease;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.6rem;
      font-weight: 900;
      text-shadow: 0 0 20px var(--primary-glow);
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 0 15px var(--primary-color));
    }

    .logo-img {
      height: 48px;
      border-radius: 12px;
      transition: transform 0.6s ease;
    }

    .logo:hover .logo-img {
      transform: rotate(360deg);
    }

    .search-container {
      flex: 1;
      min-width: 220px;
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      font-size: 1.2rem;
      opacity: 0.7;
      pointer-events: none;
      z-index: 2;
    }

    #searchBar {
      width: 100%;
      padding: 0.75rem 1.3rem 0.75rem 2.8rem;
      border: 2px solid var(--input-border);
      border-radius: 9999px;
      background: var(--input-bg);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #searchBar::placeholder {
      color: var(--search-placeholder);
      font-weight: 500;
    }

    #searchBar:hover {
      border-color: var(--primary-color);
      box-shadow: 0 4px 20px var(--primary-glow), inset 0 2px 4px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    #searchBar:focus {
      outline: none;
      border-color: var(--input-border-focus);
      box-shadow: 0 0 0 4px var(--primary-glow), 0 4px 25px var(--primary-glow);
      transform: translateY(-2px);
      background: rgba(0, 0, 0, 0.2);
    }

    .control-buttons button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .control-buttons button:hover {
      opacity: 0.92;
      transform: translateY(-1px);
    }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .zone-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 28px;
      margin-top: 1.2rem;
    }

    .zone-item {
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.28s ease;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    .zone-item:hover {
      transform: translateY(-10px) scale(1.035);
      box-shadow: 0 20px 50px var(--primary-glow);
      border-color: var(--primary-color);
    }

    .zone-item img {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
    }

    .zone-item button {
      background: var(--input-bg);
      color: var(--text-color);
      border: none;
      padding: 14px;
      font-size: 1.05rem;
      cursor: pointer;
      text-align: center;
      flex-grow: 1;
      transition: background 0.2s;
      font-weight: 700;
    }

    .zone-item button:hover {
      background: var(--input-border);
    }

    #zoneViewer {
      position: fixed;
      inset: 0;
      background: var(--background-color);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .zone-header {
      background: linear-gradient(to bottom, var(--header-bg-1), var(--header-bg-2));
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
    }

    #zoneName {
      font-size: 1.45rem;
      margin: 0;
    }

    #zoneAuthor {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
    }

    .zone-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .zone-controls button {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: white;
      padding: 0.65rem 1.3rem;
      border-radius: 9999px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .zone-controls button:hover {
      background: var(--input-border);
      border-color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--primary-glow);
    }

    #zoneFrame {
      flex-grow: 1;
      border: none;
      width: 94%;
      height: 92%;
      margin: 20px auto;
      border-radius: 16px;
      box-shadow: var(--shadow);
      background: #000;
    }

    #popupOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(6px);
    }

    .popup {
      background: var(--popup-bg);
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
      width: 90%;
      max-width: 480px;
      overflow: hidden;
      transition: all 0.5s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
    }

    .popup-header {
      background: var(--primary-color);
      color: white;
      padding: 1.2rem 1.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.5s ease;
    }

    #popupTitle {
      margin: 0;
      font-size: 1.4rem;
    }

    #popupClose {
      background: none;
      border: none;
      color: white;
      font-size: 2.2rem;
      cursor: pointer;
      line-height: 1;
    }

    #popupBody {
      padding: 1.8rem;
      font-size: 1.05rem;
      line-height: 1.5;
      color: var(--text-color);
      max-height: 70vh;
      overflow-y: auto;
    }

    #popupBody button {
      width: 100%;
      padding: 1rem;
      margin: 0.8rem 0;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 9999px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px var(--primary-glow);
      position: relative;
      overflow: hidden;
    }

    #popupBody button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.5s ease, height 0.5s ease;
    }

    #popupBody button:hover::before {
      width: 300px;
      height: 300px;
    }

    #popupBody button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px var(--primary-glow);
    }

    #popupBody button:active {
      transform: translateY(0);
    }

    #popupBody input,
    #popupBody textarea {
      width: 100%;
      padding: 0.8rem 1.2rem;
      margin: 0.6rem 0 1.2rem;
      border: 1px solid var(--input-border);
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: monospace;
    }

    #popupBody input:focus,
    #popupBody textarea:focus {
      outline: none;
      border-color: var(--input-border-focus);
      box-shadow: 0 0 0 3px var(--primary-glow), 0 0 20px var(--primary-glow);
      transform: translateY(-2px);
    }

    summary {
      font-size: 1.4rem;
      font-weight: 800;
      cursor: pointer;
      padding: 0.8rem;
      background: var(--favorites-bg);
      border-radius: 12px;
      margin-bottom: 1rem;
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    summary:hover {
      background: var(--summary-bg-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--primary-glow);
    }

    footer {
      background: var(--card-bg);
      padding: 1.5rem;
      text-align: center;
      margin-top: 3rem;
      border-radius: 16px 16px 0 0;
      transition: background 0.5s ease;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .footer-links a,
    .footer-links label {
      color: var(--import-color);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .footer-links a:hover,
    .footer-links label:hover {
      text-shadow: 0 0 15px var(--primary-glow);
      transform: translateY(-2px);
    }

    /* Color Picker Styles */
    .color-picker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .color-option::before {
      content: '';
      position: absolute;
      inset: 0;
      background: inherit;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .color-option:hover::before {
      opacity: 1;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .color-option.active {
      border-color: white;
      transform: scale(1.05);
      box-shadow: 0 0 20px currentColor, 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .color-option.active::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 2rem;
      font-weight: bold;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .color-blue {
      background: linear-gradient(135deg, #0000ff, #00aaff);
    }

    .color-cyberpunk {
      background: linear-gradient(135deg, #ff00ff, #ff0099);
    }

    .color-matrix {
      background: linear-gradient(135deg, #00cc00, #009900);
    }

    .color-sunset {
      background: linear-gradient(135deg, #ff6b35, #ff9933);
    }

    /* Input type color override */
    .color-picker-input {
      width: 100%;
      height: 60px;
      cursor: pointer;
      border: none;
      padding: 0;
      background: none;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .color-picker-input::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    
    .color-picker-input::-webkit-color-swatch {
      border: none;
      border-radius: 12px;
    }

    /* Custom Theme Options */
    .theme-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
    }

    .theme-option img {
      width: 70%;
      height: 70%;
      object-fit: contain;
      border-radius: 8px;
    }

    .theme-option:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .theme-option.active {
      border-color: white;
      transform: scale(1.05);
      box-shadow: 0 0 20px var(--primary-color), 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .theme-option.active::after {
      content: '‚úì';
      position: absolute;
      bottom: 8px;
      right: 8px;
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      background: var(--primary-color);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-default {
      background: linear-gradient(135deg, #050505, #0a0a0a);
    }

    .theme-library {
      background: linear-gradient(135deg, #050505, #cc0000);
    }

    .theme-elias {
      background: linear-gradient(135deg, #050505, #ff8c00);
    }

    .theme-lebron {
      background: linear-gradient(135deg, #050505, #552583);
    }

    .theme-kirk {
      background: linear-gradient(135deg, #050505, #e60000);
    }

    .theme-steam {
      background: linear-gradient(135deg, #050505, #66c0f4);
    }
    .theme-epstein { 
      background: linear-gradient(135deg, #050505, #666666);
    }

    /* Settings Tabs */
    .settings-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--input-border);
      overflow-x: auto;
    }

    .settings-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-color);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
    }

    .settings-tab:hover {
      color: var(--primary-color);
    }

    .settings-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .settings-panel {
      display: none;
    }

    .settings-panel.active {
      display: block;
    }
    
    .code-export-box {
        background: rgba(0,0,0,0.5);
        color: #00ff00;
        font-family: 'Courier New', monospace;
        padding: 1rem;
        border-radius: 8px;
        width: 100%;
        min-height: 200px;
        border: 1px solid #333;
        resize: vertical;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .search-container {
        width: 100%;
      }

      .zone-container {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
      }

      .zone-controls {
        flex-direction: column;
        gap: 12px;
      }

      .zone-controls button {
        width: 100%;
      }
    }
  </style>
</head>

<body data-theme="default">

  <div class="bg-particles" id="bgParticles"></div>

  <header>
    <div class="header-content">
      <div class="logo">
        <img src="https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa" alt="Logo" class="logo-img" id="headerLogo">
        <span id="headerText">Story Network GN Math</span>
      </div>

      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchBar" placeholder="Search Games..." oninput="filterZones()">
      </div>

      <div class="control-buttons">
   
        <button class="control-button" onclick="window.open('https://docs.google.com/document/d/1ip8XBOUzU7pzqmPxc2T8YJKHfbYwn6ZmFIPNd7ta708/edit?tab=t.pbpbt3le3921', '_blank')">
          üìö Library
        </button>
        <button class="control-button" id="settings">‚öôÔ∏è Settings</button>
      </div>
    </div>
  </header>
<!-- CATEGORY NAVIGATION BAR -->
  <div class="category-nav-wrapper collapsed" id="categoryNavWrapper">
    <button class="category-toggle" onclick="toggleCategoryNav()">
      <span>Categories</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
    <div class="category-nav">
      <button class="category-btn active" onclick="filterByCategory('all')">All Games</button>
      <button class="category-btn" onclick="filterByCategory('popular')">üî• Popular</button>
      <button class="category-btn" onclick="filterByCategory('story-network')">üìö Story Network</button>
      <button class="category-btn" onclick="filterByCategory('fnf')">üé§ FNF</button>
      <button class="category-btn" onclick="filterByCategory('fnaf')">üêª FNAF</button>
      <button class="category-btn" onclick="filterByCategory('minecraft')">‚õèÔ∏è Minecraft</button>
      <button class="category-btn" onclick="filterByCategory('toby-fox')">üéµ Toby Fox</button>
    </div>
  </div>
  <main>

    <details id="favoriteZonesWrapper" open>
      <summary>Favorites</summary>
      <div id="favoriteZonesList" class="zone-container">
        <p style="text-align:center;
        padding:2rem;">No favorites yet.</p>
      </div>
    </details>

    <hr style="margin:2rem 0;
    border-color:rgba(255,255,255,0.08);">


    <details id="recentZonesWrapper" open>
      <summary>
        <span class="summary-text">Recently Played</span>
        <button class="clear-recent" onclick="clearRecent();
        event.stopPropagation();">
          Clear Recent
        </button>
      </summary>
      <div id="recentZonesList" class="zone-container">
        <p style="text-align:center;
        padding:2rem;">No recently played games.</p>
      </div>
    </details>



    <hr style="margin:2rem 0;
    border-color:rgba(255,255,255,0.08);">

    <details id="allZonesWrapper" open>
      <summary>All Games</summary>
      <div id="container" class="zone-container">Loading...</div>
    </details>

  </main>

  <div id="zoneViewer">
    <div id="zoneLoading" style="display:none;
    position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
      <div class="spinner" style="width:50px; height:50px; border:4px solid var(--primary-color); border-top:4px solid transparent;
      border-radius:50%; animation:spin 1s linear infinite;"></div>
    </div>
    <div class="zone-header">
      <div class="zone-title">
        <h2 id="zoneName">zone</h2>
        <span id="zoneId" style="display: none;"></span>
        <a id="zoneAuthor" href="#" target="_blank">by Author</a>
      </div>
      <div class="zone-controls">
        <button onclick="fullscreenZone()">Fullscreen</button>
        <button onclick="aboutBlank()">Open in New Tab</button>
        <button onclick="downloadZone()">Download</button>
     
        <button onclick="closeZone()">Close</button>
      </div>
    </div>
    <iframe id="zoneFrame"></iframe>
  </div>

  <div id="popupOverlay">
    <div class="popup">
      <div class="popup-header">
        <h3 id="popupTitle">Title</h3>
        <button id="popupClose" onclick="closePopup()">√ó</button>
      </div>
      <div id="popupBody">
        Content will be here
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-links">
  
       <a href="#" onclick="showContact(); return false;">Contact</a>
      <a href="#" onclick="loadPrivacy();
      return false;">Privacy Policy</a>
      <a href="javascript:saveData()">Export Data</a>
      <label for="importData">Import Data</label>
      <input type="file" id="importData" style="display: none;" onchange="loadData(event)">
    </div>
  </footer>

  <script>
    const container = document.getElementById('container');
    const zoneViewer = document.getElementById('zoneViewer');
    let zoneFrame = document.getElementById('zoneFrame');
    const searchBar = document.getElementById('searchBar');
    // FIXED: Removed spaces from URLs
    const zonesURL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
    const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
    let zones = [];
    let popularityData = {};

    // Theme configuration
    const themeConfig = {
      default: {
        name: "Story Network GN Math",
        logo: "https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa"
      },
      library: {
        name: "The Library GN Math",
        logo: "https://codehs.com/uploads/42b9587a6dd73b104e8ef00959c00eda"
      },
      elias: {
   
        name: "Awesome Elias",
        logo: "https://codehs.com/uploads/bd2f2da062e0ca21039d671950a1b4f2"
      },
      lebron: {
        name: "Lebron da Goat",
        logo: "https://codehs.com/uploads/4f53f068f90e1f12917f4079284218fc"
      },
      kirk: {
        name: "GN Kirk",
        logo: "https://codehs.com/uploads/253e24974900cadf0698ddb27ec82579"
      },
      epstein: {
      
        name: "Big E Math",
        logo: "https://codehs.com/uploads/e8baba644e4ec12f2f95e2ff6c183233"
      },      
      steam: {
        name: "HTML Steam",
        logo: "https://codehs.com/uploads/91d3dfec9bcbafba9a912a9b1058b5c2"
      },
      // --- NEW THEMES ADDED HERE ---
      securly: {
        name: "We Hate Securly",
        logo: "https://codehs.com/uploads/3db91fabcc5ff2565afaa29a6e9ca71d"
   
      },
	  camzzz: {
        name: "Camzzz GN Math",
        logo: "https://codehs.com/uploads/a9a10c007fe8fccd20732445bd0a74ed"
      },
      ixl: { 
        name: "IXL Learning", 
        logo: "https://upload.wikimedia.org/wikipedia/commons/7/7d/IXL_Learning.png" 
      }
      // USER GENERATED THEMES WILL BE APPLIED DYNAMICALLY
    };
    
    // Background Particles
    function createParticles() {
      const particlesContainer = document.getElementById('bgParticles');
      particlesContainer.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        particle.style.animationDelay = Math.random() * 5 + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Helper: Hex to RGB for Glow effects
    function hexToRgb(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
      });
    
      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    // Theme Switcher - FIXED to properly apply everything
    function setTheme(theme) {
      // Clear inline styles (user themes)
      document.body.removeAttribute('style');
      document.body.removeAttribute('data-custom-theme');
      // Set the color theme
      document.body.setAttribute('data-theme', theme);
      // Save to localStorage
      localStorage.setItem('theme', theme);
      localStorage.removeItem('customTheme');
      localStorage.removeItem('userColorThemeActive');
      // Update header to default
      updateHeader('default');

      // Update UI
      updateThemeUI();
      // Recreate particles with new color
      createParticles();
    }

    function setCustomTheme(customTheme) {
      // Clear inline styles (user themes)
      document.body.removeAttribute('style');
      // Remove color theme
      document.body.removeAttribute('data-theme');
      // Set custom theme
      document.body.setAttribute('data-custom-theme', customTheme);
      // Save to localStorage
      localStorage.setItem('customTheme', customTheme);
      localStorage.removeItem('theme');
      localStorage.removeItem('userColorThemeActive');
      // Update header based on custom theme
      updateHeader(customTheme);
      // Update UI
      updateThemeUI();

      // Recreate particles with new color
      createParticles();
    }

    // --- USER GENERATED THEME LOGIC ---

    function generateThemeFromColor(hex) {
        const rgb = hexToRgb(hex);
        if(!rgb) return;
        
        // Calculate darker background
        const bg1 = `rgb(${Math.max(0, rgb.r - 200)}, ${Math.max(0, rgb.g - 200)}, ${Math.max(0, rgb.b - 200)})`;
        const bg2 = `rgb(${Math.max(0, rgb.r - 180)}, ${Math.max(0, rgb.g - 180)}, ${Math.max(0, rgb.b - 180)})`;
        
        document.body.removeAttribute('data-theme');
        document.body.removeAttribute('data-custom-theme');
        
        document.body.style.setProperty('--primary-color', hex);
        document.body.style.setProperty('--primary-glow', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`);
        document.body.style.setProperty('--background-color', bg1);
        document.body.style.setProperty('--card-bg', `rgba(20, 20, 20, 0.9)`);
        document.body.style.setProperty('--shadow', `0 8px 32px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25)`);
        document.body.style.setProperty('--input-bg', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`);
        document.body.style.setProperty('--input-border', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`);
        document.body.style.setProperty('--input-border-focus', hex);
        document.body.style.setProperty('--header-bg-1', `rgba(${Math.max(0, rgb.r-50)}, ${Math.max(0, rgb.g-50)}, ${Math.max(0, rgb.b-50)}, 0.9)`);
        document.body.style.setProperty('--header-bg-2', `rgba(${Math.max(0, rgb.r-20)}, ${Math.max(0, rgb.g-20)}, ${Math.max(0, rgb.b-20)}, 0.9)`);
        document.body.style.setProperty('--summary-bg', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`);
        document.body.style.setProperty('--summary-bg-hover', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
        document.body.style.setProperty('--favorites-bg', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`);
        document.body.style.setProperty('--bg-gradient-1', bg1);
        document.body.style.setProperty('--bg-gradient-2', bg2);
        
        // Update local storage to remember we are in a user theme
        localStorage.setItem('userColorThemeActive', hex);
        localStorage.removeItem('theme');
        localStorage.removeItem('customTheme');
        
        updateHeader('default');
        createParticles();
        updateThemeUI();
    }

    function saveUserColorTheme() {
        const currentHex = localStorage.getItem('userColorThemeActive');
        if(!currentHex) {
            alert("Pick a color first!");
            return;
        }
        let saved = JSON.parse(localStorage.getItem('savedUserThemes') || "[]");
        if(!saved.includes(currentHex)) {
            saved.push(currentHex);
            localStorage.setItem('savedUserThemes', JSON.stringify(saved));
            renderSavedThemes(); // Refresh the list
        } else {
            alert("Theme already saved!");
        }
    }
    
    function deleteUserColorTheme(hex) {
        let saved = JSON.parse(localStorage.getItem('savedUserThemes') || "[]");
        saved = saved.filter(c => c !== hex);
        localStorage.setItem('savedUserThemes', JSON.stringify(saved));
        renderSavedThemes();
    }

    function renderSavedThemes() {
        const list = document.getElementById('saved-themes-list');
        if(!list) return;
        const saved = JSON.parse(localStorage.getItem('savedUserThemes') || "[]");
        list.innerHTML = '';
        
        if(saved.length === 0) {
            list.innerHTML = '<span style="grid-column: span 4; text-align:center; opacity:0.5; font-size:0.8rem;">No saved themes yet.</span>';
            return;
        }

        saved.forEach(hex => {
            const div = document.createElement('div');
            div.className = 'color-option';
            div.style.background = hex;
            div.title = "Click to apply, Right click to delete";
            div.onclick = () => generateThemeFromColor(hex);
            div.oncontextmenu = (e) => {
                e.preventDefault();
                if(confirm("Delete this saved color?")) {
                    deleteUserColorTheme(hex);
                }
            };
            
            // Check if active
            if(localStorage.getItem('userColorThemeActive') === hex) {
                div.classList.add('active');
            }
            
            list.appendChild(div);
        });
    }

    // --- ADVANCED THEME CREATOR ---
    function generateExportCode() {
        const name = document.getElementById('maker-name').value || "My Cool Theme";
        const logo = document.getElementById('maker-logo').value || "https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa";
        const color = document.getElementById('maker-color').value || "#0000ff";
        const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        
        const rgb = hexToRgb(color);
        
        const cssCode = `    /* Custom Theme: ${name} */
    body[data-custom-theme="${id}"] {
      --primary-color: ${color};
      --primary-glow: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5);
      --background-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.8);
      --popup-bg: rgba(15, 15, 15, 0.95);
      --shadow: 0 8px 32px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25);
      --input-bg: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.08);
      --input-border: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.35);
      --input-border-focus: ${color};
      --header-bg-1: rgba(${Math.max(0,rgb.r-100)}, ${Math.max(0,rgb.g-100)}, ${Math.max(0,rgb.b-100)}, 0.9);
      --header-bg-2: rgba(${Math.max(0,rgb.r-50)}, ${Math.max(0,rgb.g-50)}, ${Math.max(0,rgb.b-50)}, 0.9);
      --summary-bg: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15);
      --summary-bg-hover: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25);
      --favorites-bg: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1);
      --import-color: ${color};
      --search-placeholder: rgba(255, 255, 255, 0.4);
      --bg-gradient-1: #050505;
      --bg-gradient-2: #0a0a0a;
    }`;

        const jsCode = `      ${id}: {
        name: "${name}",
        logo: "${logo}"
      },`;
      
      const htmlCode = `            <div class="theme-option" onclick="setCustomTheme('${id}');" title="${name}" style="background: linear-gradient(135deg, #050505, ${color});">
              <img src="${logo}" alt="${name}">
            </div>`;

        const fullOutput = `/* 1. Add this to CSS: */
${cssCode}

/* 2. Add this to themeConfig in JS: */
${jsCode}

/* 3. Add this to HTML inside showColorSettings(): */
${htmlCode}`;

        const exportArea = document.getElementById('maker-export');
        exportArea.value = fullOutput;
        exportArea.style.display = 'block';
        alert("Code generated! Copy the text below and send it to the library.");
    }
    
    // --- END USER THEMES ---


    // Update header logo and text
    function updateHeader(themeKey) {
      const config = themeConfig[themeKey] || themeConfig.default;
      const logoImg = document.getElementById('headerLogo');
      const headerText = document.getElementById('headerText');

      if (logoImg) {
        logoImg.src = config.logo;
        logoImg.alt = config.name + " Logo";
      }
      if (headerText) {
        headerText.textContent = config.name;
      }
      document.title = config.name;
      // ADD THIS LINE TO CHANGE THE FAVICON:
      cloakIcon(config.logo);
    }

    // Update UI to reflect current theme
    function updateThemeUI() {
      const currentTheme = localStorage.getItem('theme') || 'default';
      const currentCustomTheme = localStorage.getItem('customTheme');
      const isUserColor = localStorage.getItem('userColorThemeActive');

      // Update color options
      document.querySelectorAll('.color-option').forEach(btn => {
        btn.classList.remove('active');
        if(!isUserColor && !currentCustomTheme) {
            const themeName = btn.classList.contains('color-blue') ? 'default' :
              btn.classList.contains('color-cyberpunk') ? 'cyberpunk' :
              btn.classList.contains('color-matrix') ? 'matrix' :
              btn.classList.contains('color-sunset') ? 'sunset' : '';
            if (currentTheme === themeName) {
              btn.classList.add('active');
            }
        }
      });
      // Update custom theme options
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.remove('active');
        // Only active if NOT in user color mode
        if(!isUserColor) {
            const customName = btn.classList.contains('theme-default') ? 'default' :
              btn.classList.contains('theme-library') ? 'library' :
              btn.classList.contains('theme-elias') ? 'elias' :
              btn.classList.contains('theme-lebron') ? 'lebron' :
              btn.classList.contains('theme-kirk') ? 'kirk' :
              btn.classList.contains('theme-steam') ? 'steam' : 
              btn.dataset.customTheme ? btn.dataset.customTheme : '';
              
            // Specific check for Securly/Camzzz/IXL via title attribute matching or manual check
            let isMatch = false;
            if(btn.title === "Securly" && currentCustomTheme === "securly") isMatch = true;
            if(btn.title === "Camzzz" && currentCustomTheme === "camzzz") isMatch = true;
            if(btn.title === "IXL Learning" && currentCustomTheme === "ixl") isMatch = true;
            if(btn.title === "Epstein" && currentCustomTheme === "epstein") isMatch = true;
            
            if (currentCustomTheme === customName || (!currentCustomTheme && customName === 'default' && currentTheme === 'default') || isMatch) {
              btn.classList.add('active');
            }
        }
      });
      
      // Update saved user themes UI
      renderSavedThemes();
    }

    // Load saved theme on startup
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      const savedCustomTheme = localStorage.getItem('customTheme');
      const savedUserColor = localStorage.getItem('userColorThemeActive');

      if(savedUserColor) {
          generateThemeFromColor(savedUserColor);
      } else if (savedCustomTheme) {
        document.body.setAttribute('data-custom-theme', savedCustomTheme);
        updateHeader(savedCustomTheme);
      } else if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
        updateHeader('default');
      } else {
        document.body.setAttribute('data-theme', 'default');
        updateHeader('default');
      }

      updateThemeUI();
    }

    function recordRecent(id) {
      let recents = JSON.parse(localStorage.getItem("recentZones") || "[]");
      recents = [id, ...recents.filter(x => x !== id)].slice(0, 12);
      localStorage.setItem("recentZones", JSON.stringify(recents));
      updateRecentlyPlayed();
    }

    function removeFromRecentlyPlayed(id) {
      let recents = JSON.parse(localStorage.getItem("recentZones") || "[]");
      recents = recents.filter(x => x !== id);
      localStorage.setItem("recentZones", JSON.stringify(recents));
      updateRecentlyPlayed();
    }

    function clearRecent() {
      if (confirm('Clear all recent games?')) {
        localStorage.removeItem('recentZones');
        updateRecentlyPlayed();
      }
    }


    function updateRecentlyPlayed() {

      const recents = JSON.parse(localStorage.getItem("recentZones") || "[]");
      const list = document.getElementById("recentZonesList");
      if (!list) return;

      list.innerHTML = "";
      if (recents.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:2rem;">No recently played games</p>';
        return;
      }

      recents.forEach(id => {

        const zone = zones.find(z => z.id == id);
        if (!zone) return;

        const card = createZoneCard(zone, "recent");

        const remove = document.createElement("div");
        remove.className = "recent-remove";
        remove.innerHTML = `
      <svg viewBox="0 0 24 24">
        <line x1="6" y1="6" x2="18" y2="18"/>
 
        <line x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    `;

        remove.onclick = (e) => {
          e.stopPropagation();
          card.style.opacity = "0";
          card.style.transform = "scale(0.8)";
          setTimeout(() => {
            removeFromRecentlyPlayed(id);
         
          }, 200);
        };

        card.appendChild(remove);
        list.appendChild(card);
      });
    }


    async function listZones() {
      try {
        const response = await fetch(zonesURL + "?t=" + Date.now());
        const json = await response.json();

// ============ CATEGORY CONFIGURATION ============
    // Story Network games (hidden from All Games section)
    const storyNetworkGames = [
      { id: 'lib', name: 'The Library:', author: 'Camzzz', url: 'https://docs.google.com/document/d/1ip8XBOUzU7pzqmPxc2T8YJKHfbYwn6ZmFIPNd7ta708/edit?tab=t.pbpbt3le3921', cover: 'https://codehs.com/uploads/42b9587a6dd73b104e8ef00959c00eda' },
      { id: 'raz', name: 'raz.launcher', author: 'Camzzz', url: 'https://webmaker.app/create/T3baO7VwpZ?layout=4/', cover: 'https://codehs.com/uploads/657ae227967f2a74ff60938003ba5e8d' },
      { id: 'sgc', name: 'Story Network Google Classroom', author: 'Camzzz', url: 'https://classroom.google.com/c/ODQyMTAyMTUwMzI1?cjc=zopuekrn', cover: 'https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa' },
      { id: 'zicon', name: 'zicon', author: 'Camzzz', url: 'https://camzzz-alt.github.io/zicon/?scrlcbp=.', cover: 'https://codehs.com/uploads/be466224b603908717d7cff7681a05d5' }
    ];

    // Manual popular games (add game IDs here to force them into Popular section)
    const manualPopularIds = [
      // Add game IDs here like: 123, 456, etc.
    ];

    let currentCategory = 'all';

// Toby Fox games removed
const tobyFoxGames = [];

// Combine Story Network + Toby Fox + fetched JSON
zones = [...storyNetworkGames, ...tobyFoxGames, ...json];
    await fetchPopularity();
    sortZones();
    updateRecentlyPlayed();

        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        const embed = window.location.hash.includes("embed");
        if (id) {
          const zone = zones.find(zone => zone.id + '' == id + '');
        if (zone) {
            if (embed) {
              if (zone.url.startsWith("http")) {
                window.open(zone.url, "_blank");
            } else {
                const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
            fetch(url + "?t=" + Date.now()).then(response => response.text()).then(html => {
                  document.documentElement.innerHTML = html;
                  const popup = document.createElement("div");
                  popup.style.position = "fixed";
                  popup.style.bottom = "20px";
           
                  popup.style.right = "20px";
                  popup.style.backgroundColor = "#cce5ff";
                  popup.style.color = "#004085";
                  popup.style.padding = "10px";
                  popup.style.border = "1px solid #b8daff";
         
                  popup.style.borderRadius = "5px";
                  popup.style.boxShadow = "0px 0px 10px rgba(0,0,0,0.1)";
                  popup.style.fontFamily = "Arial, sans-serif";
                  popup.innerHTML = `Play more games at <a href="https://gn-math.github.io" target="_blank" style="color:#004085; font-weight:bold;">https://gn-math.github.io</a>!`;
                 
                  const closeBtn = document.createElement("button");
                  closeBtn.innerText = "‚úñ";
                  closeBtn.style.marginLeft = "10px";
                  closeBtn.style.background = "none";
                  closeBtn.style.border = "none";
                  closeBtn.style.cursor = "pointer";
                  closeBtn.style.color = "#004085";
                  closeBtn.style.fontWeight = "bold";
                  closeBtn.onclick = () => popup.remove();
                  popup.appendChild(closeBtn);
                  document.body.appendChild(popup);
            document.documentElement.querySelectorAll('script').forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) newScript.src = oldScript.src;
                    else newScript.textContent = oldScript.textContent;
                    document.body.appendChild(newScript);
        
                  });
                }).catch(error => alert("Failed to load zone: " + error));
            }
            } else {
              openZone(zone);
            }
          }
        }
      } catch (error) {
        console.error(error);
        container.innerHTML = `Error loading zones: ${error}`;
      }
    }

    async function fetchPopularity() {
      try {
        const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await response.json();
        data.forEach(file => {
          const idMatch = file.name.match(/\/(\d+)\.html$/);
          if (idMatch) {
            const id = parseInt(idMatch[1]);
            popularityData[id] = file.hits.total;
          }
        });
      } catch (error) {
        popularityData[0] = 0;
      }
    }

function sortZones() {
  // Story Network games should NEVER appear in All Games
  const storyNetworkIds = ['lib', 'raz', 'sgc', 'zicon'];
  
  // Filter out Story Network games for display
  const displayableZones = zones.filter(z => !storyNetworkIds.includes(z.id));
  
  // Sort alphabetically
  displayableZones.sort((a, b) => a.name.localeCompare(b.name));
  
  // Display only non-Story Network games
  displayZones(displayableZones);
  updateRecentlyPlayed();
  updateFavorites();
}

    function displayZones(zonesToShow) {
      container.innerHTML = "";
      zonesToShow.forEach(file => {
        const card = createZoneCard(file, "normal");
        container.appendChild(card);
      });
      if (container.innerHTML === "") {
        container.innerHTML = "No zones found.";
      } else {
        document.getElementById("allZonesWrapper")
          .querySelector("summary")
          .textContent = `All Games (${zonesToShow.length})`;
      }
    }

    function createZoneCard(file, mode = "normal") {

      const zoneItem = document.createElement("div");
      zoneItem.className = "zone-item";
      zoneItem.onclick = () => openZone(file);
      /* ---------- STAR (NOT FOR RECENTS) ---------- */
      if (mode !== "recent") {

        const star = document.createElement("div");
        star.className = "favorite-star";
        star.innerHTML = `
      <svg viewBox="0 0 24 24">
        <polygon points="12 2 15 9 22 9 17 14 19 22 12 18 5 22 7 14 2 9 9 9"></polygon>
      </svg>
    `;
        if (getFavorites().includes(file.id)) {
          star.classList.add("active");
        }

        star.onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(file.id, star);
        };

        zoneItem.appendChild(star);
      }

      /* ---------- IMAGE ---------- */
      const img = document.createElement("img");
      // Handle custom pinned game covers vs external covers
      if (file.cover && file.cover.startsWith("http")) {
        img.dataset.src = file.cover;
      } else {
        img.dataset.src = file.cover
          .replace("{COVER_URL}", coverURL)
          .replace("{HTML_URL}", htmlURL);
      }

      img.alt = file.name;
      img.loading = "lazy";
      img.className = "lazy-zone-img";
      /* ---------- BUTTON ---------- */
      const btn = document.createElement("button");
      btn.textContent = file.name;
      btn.onclick = (e) => {
        e.stopPropagation();
        openZone(file);
      };

      zoneItem.appendChild(img);
      zoneItem.appendChild(btn);
      /* ---------- LAZY LOAD ---------- */
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.src = entry.target.dataset.src;
            entry.target.classList.remove("lazy-zone-img");
            obs.unobserve(entry.target);
          }
        });
    
      }, {
        rootMargin: "120px",
        threshold: 0.1
      });
      observer.observe(img);

      return zoneItem;
    }



    function filterZones() {
      const query = searchBar.value.toLowerCase();
      const filteredZones = zones.filter(zone => zone.name.toLowerCase().includes(query));
      displayZones(filteredZones);
    }

    function openZone(file) {
      recordRecent(file.id);
      if (file.url.startsWith("http")) {
        window.open(file.url, "_blank");
      } else {
        document.getElementById('zoneName').textContent = "Loading...";
        zoneFrame.style.opacity = "0.3";
        zoneFrame.style.pointerEvents = "none";
        document.getElementById("zoneLoading").style.display = "block";

        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);

        fetch(url + "?t=" + Date.now())
          .then(response => response.text())
          .then(html => {
            if (zoneFrame.contentDocument === null) {
              zoneFrame = document.createElement("iframe");
              zoneFrame.id = "zoneFrame";
              zoneViewer.appendChild(zoneFrame);
 
           }
            zoneFrame.contentDocument.open();
            zoneFrame.contentDocument.write(html);
            zoneFrame.contentDocument.close();
            zoneFrame.style.opacity = "1";
            zoneFrame.style.pointerEvents = "auto";
            document.getElementById("zoneLoading").style.display = "none";

           
            document.getElementById('zoneName').textContent = file.name;
            document.getElementById('zoneId').textContent = file.id;
            document.getElementById('zoneAuthor').textContent = "by " + file.author;
            if (file.authorLink) document.getElementById('zoneAuthor').href = file.authorLink;
            zoneViewer.style.display = "block";
            const newURL = new URL(window.location);
            newURL.searchParams.set('id', file.id);
            history.pushState(null, '', newURL.toString());
          })
          .catch(error => {
            document.getElementById("zoneLoading").style.display = "none";
            alert("Failed to load zone: " + error);
          });
      }
    }

    function aboutBlank() {
      const newWindow = window.open("about:blank", "_blank");
      let zone = zones.find(z => z.id + '' === document.getElementById('zoneId').textContent);
      const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
      fetch(url + "?t=" + Date.now()).then(r => r.text()).then(html => {
        if (newWindow) {
          newWindow.document.open();
          newWindow.document.write(html);
          newWindow.document.close();
        }
      });
      }

    function closeZone() {
      zoneViewer.style.display = "none";
      const url = new URL(window.location);
      url.searchParams.delete('id');
      history.pushState(null, '', url.toString());
    }

    function downloadZone() {
      let zone = zones.find(z => z.id + '' === document.getElementById('zoneId').textContent);
      fetch(zone.url.replace("{HTML_URL}", htmlURL) + "?t=" + Date.now())
        .then(res => res.text())
        .then(text => {
          const blob = new Blob([text], {
            type: "text/plain;charset=utf-8"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href 
          = url;
          a.download = zone.name + ".html";

          a.click();
          URL.revokeObjectURL(url);
        });
      }

    function fullscreenZone() {
      const el = zoneFrame;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
      }

    function saveData() {
      let data = JSON.stringify(localStorage) + "\n\n|\n\n" + document.cookie;
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([data], {
        type: "text/plain"
      }));
      link.download = `${Date.now()}.data`;
      link.click();
    }

    function loadData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const [lsData, cookieData] = e.target.result.split("\n\n|\n\n");
        try {
          const parsed = JSON.parse(lsData);
          for (let key in parsed) localStorage.setItem(key, parsed[key]);
        } catch {}
        if (cookieData) {
          cookieData.split("; ").forEach(c => document.cookie = c);
      }
        alert("Data loaded");
        location.reload();
      };
      reader.readAsText(file);
      }

    function cloakIcon(url) {
      const link = document.querySelector("link[rel~='icon']") || document.createElement('link');
      link.rel = "icon";
      link.href = url.trim() || "favicon.png";
      document.head.appendChild(link);
    }

    function cloakName(string) {
      document.title = string.trim() ||
      "Home";
    }

    function tabCloak() {
      closePopup();
      document.getElementById('popupTitle').textContent = "Tab Cloak";
      document.getElementById('popupBody').innerHTML = `
        <label for="tab-cloak-title">Set Tab Title:</label><br>
        <input type="text" id="tab-cloak-title" placeholder="Enter new tab name..." oninput="cloakName(this.value)"><br><br>
        <label for="tab-cloak-icon">Set Tab Icon URL:</label><br>
        <input type="text" id="tab-cloak-icon" placeholder="Enter icon URL..." oninput="cloakIcon(this.value)">
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function showColorSettings() {
      closePopup();
      const currentTheme = localStorage.getItem('theme') || 'default';
      const currentCustomTheme = localStorage.getItem('customTheme');
      const isUserColor = localStorage.getItem('userColorThemeActive');

      document.getElementById('popupTitle').textContent = "Appearance";
      document.getElementById('popupBody').innerHTML = `
        <div class="settings-tabs">
          <button class="settings-tab active" onclick="switchSettingsTab('colors', this)">Color</button>
          <button class="settings-tab" onclick="switchSettingsTab('custom', this)">Custom</button>
          <button class="settings-tab" onclick="switchSettingsTab('maker', this)">Creator</button>
        </div>
        
        <div class="settings-panel active" id="colors-panel">
          <p style="margin-bottom: 0.5rem; color: var(--text-color);">Choose your color theme:</p>
          <div class="color-picker-grid">
             <div class="color-option color-blue ${!isUserColor && !currentCustomTheme && currentTheme === 'default' ? 'active' : ''}" onclick="setTheme('default');"
             title="Classic Blue"></div>
            <div class="color-option color-cyberpunk ${!isUserColor && !currentCustomTheme && currentTheme === 'cyberpunk' ? 'active' : ''}" onclick="setTheme('cyberpunk');"
             title="Cyberpunk"></div>
            <div class="color-option color-matrix ${!isUserColor && !currentCustomTheme && currentTheme === 'matrix' ? 'active' : ''}" onclick="setTheme('matrix');"
             title="Matrix"></div>
            <div class="color-option color-sunset ${!isUserColor && !currentCustomTheme && currentTheme === 'sunset' ? 'active' : ''}" onclick="setTheme('sunset');"
             title="Sunset"></div>
          </div>
          
          <hr style="margin: 1.5rem 0; border-color: var(--input-border);">
          
          <p style="margin-bottom: 0.5rem; color: var(--text-color);">Make your own color theme:</p>
          <div style="display:flex; gap:10px; align-items:center;">
             <input type="color" class="color-picker-input" id="simple-color-picker" oninput="generateThemeFromColor(this.value)">
             <button onclick="saveUserColorTheme()" style="width: 7rem; padding: 1rem 1rem;">Save</button>
          </div>
          <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Pick a color and it will automatically generate a theme!</p>

          <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-color);">Previously Made Themes:</p>
          <div class="color-picker-grid" id="saved-themes-list">
             </div>
        </div>
        
        <div class="settings-panel" id="custom-panel">
          <p style="margin-bottom: 1rem; color: var(--text-color);">Choose your custom theme:</p>
          <div class="color-picker-grid">
            <div class="theme-option theme-default ${!isUserColor && !currentCustomTheme && currentTheme === 'default' ? 'active' : ''}" onclick="setTheme('default');"
             title="GN Math">
              <img src="https://codehs.com/uploads/84799a0bb8e09668879b73acd5e7abaa" alt="GN Math">
            </div>
            <div class="theme-option theme-library ${currentCustomTheme === 'library' ? 'active' : ''}" onclick="setCustomTheme('library');"
             title="The Library">
              <img src="https://codehs.com/uploads/42b9587a6dd73b104e8ef00959c00eda" alt="Library">
            </div>
            <div class="theme-option theme-elias ${currentCustomTheme === 'elias' ? 'active' : ''}" onclick="setCustomTheme('elias');"
             title="Awesome Elias">
              <img src="https://codehs.com/uploads/bd2f2da062e0ca21039d671950a1b4f2" alt="Elias">
            </div>
            <div class="theme-option theme-lebron ${currentCustomTheme === 'lebron' ? 'active' : ''}" onclick="setCustomTheme('lebron');"
             title="Lebron da Goat">
              <img src="https://codehs.com/uploads/4f53f068f90e1f12917f4079284218fc" alt="Lebron">
            </div>
            <div class="theme-option theme-kirk ${currentCustomTheme === 'kirk' ? 'active' : ''}" onclick="setCustomTheme('kirk');"
             title="GN Kirk">
              <img src="https://codehs.com/uploads/253e24974900cadf0698ddb27ec82579" alt="Kirk">
            </div>
            <div class="theme-option theme-steam ${currentCustomTheme === 'steam' ? 'active' : ''}" onclick="setCustomTheme('steam');"
             title="Steam">
              <img src="https://codehs.com/uploads/91d3dfec9bcbafba9a912a9b1058b5c2" alt="Steam">
            </div>
			<div class="theme-option theme-ixl ${currentCustomTheme === 'ixl' ? 'active' : ''}" onclick="setCustomTheme('ixl');"
             title="IXL Learning">
			  <img src="https://upload.wikimedia.org/wikipedia/commons/7/7d/IXL_Learning.png" alt="IXL">
			</div>
			
            <div class="theme-option theme-epstein ${currentCustomTheme === 'epstein' ? 'active' : ''}" data-custom-theme="epstein" onclick="setCustomTheme('epstein')">
              <img src="https://codehs.com/uploads/e8baba644e4ec12f2f95e2ff6c183233" alt="Epstein">
            </div>
            <div class="theme-option ${currentCustomTheme === 'securly' ? 'active' : ''}" style="background:#007bff;"
             onclick="setCustomTheme('securly');" title="Securly">
              <img src="https://codehs.com/uploads/3db91fabcc5ff2565afaa29a6e9ca71d" alt="Securly">
            </div>
            <div class="theme-option ${currentCustomTheme === 'camzzz' ? 'active' : ''}" style="background:#AA00FF;"
             onclick="setCustomTheme('camzzz');" title="Camzzz">
              <img src="https://codehs.com/uploads/a9a10c007fe8fccd20732445bd0a74ed" alt="Camzzz">
            </div>
          </div>
          <p style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.7; color: var(--text-color);">Suggest New Themes in the Library!</p>
        </div>

        <div class="settings-panel" id="maker-panel">
            <p style="color: var(--text-color); margin-bottom: 1rem;">Create a unique theme for the community!</p>
            
            <label>Theme Name</label>
            <input type="text" id="maker-name" placeholder="e.g. Neon Nights">
            
            <label>Logo URL</label>
            <input type="text" id="maker-logo" placeholder="https://...">
            
            <label>Primary Color</label>
            <input type="color" class="color-picker-input" id="maker-color" value="#0000ff">
            
            <button onclick="generateExportCode()">Generate Code to Export</button>
            
            <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.8;">Copy the code below and put it in the Library so we can see it!</p>
            <textarea id="maker-export" class="code-export-box" readonly style="display:none;"></textarea>
        </div>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
      renderSavedThemes();
    }

    function switchSettingsTab(tab, btn) {
      // Update tab buttons
      document.querySelectorAll('.settings-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update panels
      document.querySelectorAll('.settings-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(tab + '-panel').classList.add('active');
    }

    document.getElementById('settings').addEventListener('click', () => {
      document.getElementById('popupTitle').textContent = "Settings";
      document.getElementById('popupBody').innerHTML = `
        <button onclick="showColorSettings()">üé® Appearance</button>
        <button onclick="tabCloak()">üé≠ Tab Cloak</button>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    });
    function showContact() {
      document.getElementById('popupTitle').textContent = "Contact";
      document.getElementById('popupBody').innerHTML = `
        <p>Discord: https://discord.gg/NAFw4ykZ7n</p>
        <p>Email: gn.math.business@gmail.com</p>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function loadPrivacy() {
      document.getElementById('popupTitle').textContent = "Privacy Policy";
      document.getElementById('popupBody').innerHTML = `
        <div style="max-height:60vh; overflow-y:auto;">
          <h2>PRIVACY POLICY</h2>
          <p>Last updated April 17, 2025</p>
          <p>This Privacy Notice describes how gn-math collects, uses, and shares personal information...</p>
        </div>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function closePopup() {
      document.getElementById('popupOverlay').style.display = "none";
    }

    function getFavorites() {
      return JSON.parse(localStorage.getItem("favorites") || "[]");
    }

    function saveFavorites(arr) {
      localStorage.setItem("favorites", JSON.stringify(arr));
    }

    function toggleFavorite(id, starEl) {
      let favs = getFavorites();
      if (favs.includes(id)) {
        favs = favs.filter(x => x !== id);
        starEl.classList.remove("active");
      } else {
        favs.push(id);
        starEl.classList.add("active");
        spawnParticles(starEl);
      }

      saveFavorites(favs);
      updateFavorites();
    }

    function spawnParticles(star) {
      for (let i = 0; i < 10; i++) {
        const p = document.createElement("div");
        p.className = "star-particle";
        p.style.left = "50%";
        p.style.top = "50%";
        p.style.setProperty("--x", `${(Math.random()-0.5)*60}px`);
        p.style.setProperty("--y", `${(Math.random()-0.5)*60}px`);
        star.appendChild(p);
        setTimeout(() => p.remove(), 600);
      }
    }

    function updateFavorites() {
      const list = document.getElementById("favoriteZonesList");
      const favs = getFavorites();
      list.innerHTML = "";
      if (favs.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:2rem;">No favorites yet.</p>';
        return;
      }

      favs.forEach(id => {
        const zone = zones.find(z => z.id == id);
        if (!zone) return;

        const item = createZoneCard(zone, "favorite");
        list.appendChild(item);
      });
      document.getElementById("favoriteZonesWrapper")
        .querySelector("summary")
        .innerHTML = `Favorites (${favs.length})`;
    }

    // Initialize
    loadSavedTheme(); // Load theme before creating particles
    createParticles();
    listZones();

    const schoolList = ["deledao", "goguardian", "lightspeed", "linewize", "securly", ".edu/"];
    function isBlockedDomain(url) {
      const domain = new URL(url, location.origin).hostname + "/";
      return schoolList.some(s => domain.includes(s));
    }

    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (isBlockedDomain(url)) return Promise.reject(new Error("blocked"));
      return originalFetch.apply(this, arguments);
    };

    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
      if (isBlockedDomain(url)) return;
      return originalOpen.apply(this, arguments);
    };

    HTMLCanvasElement.prototype.toDataURL = function() {
      return "";
    };
    
    // ============ CATEGORY FUNCTIONS ============

// Toggle category nav open/closed
function toggleCategoryNav() {
  const wrapper = document.getElementById('categoryNavWrapper');
  wrapper.classList.toggle('collapsed');
}

// Filter games by category
function filterByCategory(category) {
  currentCategory = category;
  
  // Update active button
  document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Get Story Network IDs (always hidden from All Games)
  const storyNetworkIds = ['lib', 'raz', 'sgc', 'zicon'];
  
  let filteredZones = [];
  
  if (category === 'all') {
    // Show all games EXCEPT Story Network games
    filteredZones = zones.filter(z => !storyNetworkIds.includes(z.id));
  } 
  else if (category === 'story-network') {
    // Show ONLY Story Network games
    filteredZones = zones.filter(z => storyNetworkIds.includes(z.id));
  }
  else if (category === 'popular') {
    // Show popular games (top 15 by stats + manual additions)
    const manualPopularIds = []; // Add IDs here like: ['raz', 'lib']
    
    // Get top games by popularity data
    const sortedByPopularity = zones
      .filter(z => !storyNetworkIds.includes(z.id)) // Exclude Story Network
      .filter(z => popularityData[z.id] > 0)
      .sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0))
      .slice(0, 15);
    
    // Combine manual + auto popular (remove duplicates)
    const popularIds = [...new Set([...manualPopularIds, ...sortedByPopularity.map(z => z.id)])];
    filteredZones = zones.filter(z => popularIds.includes(z.id));
  }
  else if (category === 'fnf') {
    // Friday Night Funkin games
    filteredZones = zones.filter(z => 
      !storyNetworkIds.includes(z.id) && 
      (z.name.toLowerCase().includes('fnf') || z.name.toLowerCase().includes('friday night funkin'))
    );
  }
  else if (category === 'fnaf') {
    // Five Nights at Freddy's games
    filteredZones = zones.filter(z => 
      !storyNetworkIds.includes(z.id) && 
      (z.name.toLowerCase().includes('fnaf') || z.name.toLowerCase().includes('five nights at'))
    );
  }
  else if (category === 'minecraft') {
    // Minecraft games
    filteredZones = zones.filter(z => 
      !storyNetworkIds.includes(z.id) && 
      z.name.toLowerCase().includes('minecraft')
    );
  }
  else if (category === 'toby-fox') {
  // Toby Fox games
  filteredZones = zones.filter(z => 
    !storyNetworkIds.includes(z.id) && 
    (z.name.toLowerCase().includes('undertale') || 
     z.name.toLowerCase().includes('deltarune') ||
     z.name.toLowerCase().includes('underwheels') ||
     z.name.toLowerCase().includes('deltatraveler'))
  );
}
  
  // Update the display
  displayZones(filteredZones);
  
  // Update summary title
  const summaryText = category === 'all' ? 'All Games' :
                      category === 'story-network' ? 'Story Network' :
                      category === 'popular' ? 'Popular' :
                      category === 'fnf' ? 'FNF' :
                      category === 'fnaf' ? 'FNAF' :
                      category === 'minecraft' ? 'Minecraft' : 'Games';
  
  document.getElementById("allZonesWrapper")
    .querySelector("summary")
    .textContent = `${summaryText} (${filteredZones.length})`;
}
  </script>
</body>

</html>
